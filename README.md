# Пример обработчика службы доставки с использованием координат (DBS) 

Обработчик предоставляет возможность использовать зоны доставки модуля `angerro.yadelivery` при обработке заказов модуля yandex.market по модели DBS.

Обращаем внимание, что код обработчика службы доставки является примером для
разработчиков магазина. Интеграция, тестирование и поддержка является ответственностью
разработчиков магазина.

Системные требования:
* 1С-Битрикс: Управление сайтом;
* Модуль Интернет-магазин (sale) версии больше 17.5;
* Модуль `yandex.market` версии больше 2.2.2;
* Модуль `angerro.yadelivery`.

## Установка

1. Установите модули [yandex.market](https://marketplace.1c-bitrix.ru/solutions/yandex.market/) и [angerro.yadelivery](https://marketplace.1c-bitrix.ru/solutions/angerro.yadelivery/);
2. Скопируйте содержимое репозитория в папку `bitrix/php_interface/include/sale_delivery/angerroyadeliverydemo`;
3. Если сайт работает в кодировке windows-1251, конвертируйте содержимое файла `bitrix/php_interface/include/sale_delivery/angerroyadeliverydemo/lang/ru/handler.php`.

## Настройка модуля yandex.market

Модуль yandex.market необходимо настроить для передачи координат адреса доставки в свойства заказа. 

Порядок действий ([видео-инструкция](https://disk.yandex.ru/i/J-nwxMZkqzyfkg)):

1. Создайте служебные свойства заказа типа плательщика Физическое лицо с символьными кодами `LAT` и `LON`;
2. Перейдите на страницу Маркет для Бизнеса → Обработка заказов из маркетплейса → Настройки, выберите модель DBS. На вкладке Оплата и доставка укажите, созданные на 3-ем шаге, свойства в качестве значений полей Географическая широта (lat) и Географическая долгота (lon);
3. Перейдите на страницу Магазин → Настройки → Местоположения → Внешние сервисы. Создайте сервисы с кодами `LAT` и `LON`;
4. Перейдите на страницу Магазин → Настройки → Местоположения → Список местоположений, откройте форму редактирования для местоположения Москва. На вкладке Внешние данные укажите для сервисов `LAT` и `LON` координаты, которые будут использоваться по умолчанию (пока пользователь не заполнил адрес).

## Настройка службы доставки

Порядок действий ([видео-инструкция](https://disk.yandex.ru/i/I1KJNEpVEJhipg)):

1. Перейдите на страницу Настройки → Настройки продукта → Настройки модулей → Зоны доставки на Яндекс картах;
2. На вкладке Создание карты зон доставки разметьте регионы, правила описания цены для зоны: указывается как price: XXX, где XXX - стоимость доставки;
3. Перейдите на страницу Магазин → Настройки → Службы доставки, нажмите Добавить в правом верхнем углу, выберите пункт «Зоны доставки angerro.yadelivery (демо)»;
4. Заполните Название и Описание доставки, на вкладке Настройки необходимо выбрать Карту и указать символьные коды свойств LAT и LON, в которые передаются координаты в модуле yandex.market;
5. Нажмите Применить, добавьте Ограничение на Источник заказа Яндекс.Маркет и Местоположения;
6. Добавьте службу доставки на странице Настройки обработки заказов по модели DBS;
7. Выполните тестирование в личном кабинете Яндекс.Маркет на странице Настройки → Работа с тестовыми заказами. Выберите город и товары, нажмите Проверить наличие, введите Адрес доставки и нажмите Отправить заказ, при изменении цены отобразиться соответствующие предупреждение, после необходимо нажать Отправить заказ повторно.